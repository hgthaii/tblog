<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<title>Admin · TBlog</title>
	<link rel="stylesheet" href="/css/main.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

	<form method="post" action="/admin" class="admin-layout">
		<!-- LEFT -->
		<div class="admin-editor">
			<input type="hidden" name="id" th:value="${post.id}" />

			<div class="form-group">
				<label class="form-label">Tiêu đề</label>
				<input class="form-control" name="title" id="title" th:value="${post.title}" required />
			</div>

			<div class="form-group">
				<label class="form-label">Slug</label>
				<input class="form-control" name="slug" id="slug" th:value="${post.slug}" data-manual="false"
					required />
			</div>

			<div class="form-group">
				<label class="form-label">Người viết</label>
				<input class="form-control" name="authorName" placeholder="Author" />
			</div>

			<div class="form-group">
				<label class="form-label">Thể loại</label>
				<input class="form-control" name="categorySlug" placeholder="Category slug" />
			</div>

			<div class="form-group">
				<label class="form-label">Tags</label>
				<input class="form-control" name="tags" placeholder="dev, blog, spring" />
			</div>

			<div class="form-group">
				<label class="form-label">Nội dung (Markdown)</label>
				<textarea class="form-control" name="content" id="content" th:text="${post.content}"></textarea>
			</div>

			<div style="display:flex; gap:12px; margin-top: 24px;">
				<button type="submit" class="btn" th:text="${mode == 'edit' ? 'Update' : 'Publish'}"></button>

				<button type="button" th:if="${mode == 'edit'}" th:onclick="|confirmDelete(${post.id})|"
					class="btn btn-danger">
					Delete
				</button>
			</div>
		</div>

		<!-- RIGHT -->
		<div class="admin-preview">
			<div id="preview" class="markdown-body"></div>
		</div>

	</form>

	<form id="deleteForm" method="post" style="display:none;"></form>

	<script>
		const textarea = document.getElementById('content');
		const preview = document.getElementById('preview');

		function renderPreview() {
			fetch('/admin/preview', {
				method: 'POST',
				headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
				body: 'content=' + encodeURIComponent(textarea.value)
			})
				.then(res => res.text())
				.then(html => preview.innerHTML = html);
		}

		textarea.addEventListener('input', () => {
			clearTimeout(window.timer);
			window.timer = setTimeout(renderPreview, 300);
		});

		renderPreview();

		// Slug generation logic
		const titleInput = document.getElementById('title');
		const slugInput = document.getElementById('slug');

		function slugify(text) {
			return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '')
				.replace(/đ/g, 'd').replace(/[^a-z0-9\s-]/g, '').trim().replace(/\s+/g, '-').replace(/-+/g, '-');
		}

		titleInput.addEventListener('input', () => {
			if (slugInput.dataset.manual === 'true') return;
			slugInput.value = slugify(titleInput.value);
		});

		slugInput.addEventListener('input', () => {
			slugInput.dataset.manual = 'true';
		});

		function confirmDelete(id) {
			if (confirm('Xoá bài viết này nha?')) {
				const form = document.getElementById('deleteForm');
				form.action = '/admin/delete/' + id;
				form.submit();
			}
		}
	</script>
</body>

</html>